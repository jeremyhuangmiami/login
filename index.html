<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login | JeremyWorld Auth</title>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="https://cdn.firebase.com/libs/firebaseui/3.5.2/firebaseui.js"></script>
    <link type="text/css" rel="stylesheet" href="https://cdn.firebase.com/libs/firebaseui/3.5.2/firebaseui.css" />
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background-color: #f0f2f5;
            color: #333;
        }
        #auth-container {
            background-color: #fff;
            padding: 30px 40px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 400px;
            text-align: center;
            box-sizing: border-box;
        }
        h1 {
            color: #007bff;
            margin-bottom: 25px;
            font-size: 1.8em;
        }
        #loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
            display: none; /* Hidden by default */
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .firebaseui-container {
            margin-top: 20px;
        }
        #user-info {
            margin-top: 20px;
            font-size: 1.1em;
            color: #555;
        }
        #logout-button {
            background-color: #dc3545;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            margin-top: 15px;
            transition: background-color 0.2s ease;
        }
        #logout-button:hover {
            background-color: #c82333;
        }
        #back-to-site-button {
            background-color: #28a745;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            margin-top: 15px;
            transition: background-color 0.2s ease;
        }
        #back-to-site-button:hover {
            background-color: #218838;
        }
    </style>
</head>
<body>
    <div id="auth-container">
        <h1>JeremyWorld Login</h1>
        <div id="loader"></div>
        <div id="firebaseui-auth-container"></div>
        <div id="user-info" style="display:none;">
            <p>Welcome, <span id="display-name"></span>!</p>
            <p>Email: <span id="user-email"></span></p>
            <button id="logout-button">Sign Out</button>
            <button id="back-to-site-button" style="display:none;">Back to Your Site</button>
        </div>
    </div>

    <script>
        // --- YOUR FIREBASE CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyCyPk7d26WwhHM34MVbSHBMrnfSTtT213Y",
            authDomain: "jeremyworld-auth.firebaseapp.com",
            projectId: "jeremyworld-auth",
            storageBucket: "jeremyworld-auth.firebasestorage.app",
            messagingSenderId: "830728575641",
            appId: "1:830728575641:web:3d22b3b15127f0ae93f608"
        };
        // --- END OF FIREBASE CONFIGURATION ---

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();

        // Initialize the FirebaseUI Widget
        const ui = new firebaseui.auth.AuthUI(auth);

        // Get elements
        const loader = document.getElementById('loader');
        const authContainer = document.getElementById('firebaseui-auth-container');
        const userInfoDiv = document.getElementById('user-info');
        const displayNameSpan = document.getElementById('display-name');
        const userEmailSpan = document.getElementById('user-email');
        const logoutButton = document.getElementById('logout-button');
        const backToSiteButton = document.getElementById('back-to-site-button');

        // Configure FirebaseUI.
        const uiConfig = {
            callbacks: {
                signInSuccessWithAuthResult: function(authResult, redirectUrl) {
                    // User successfully signed in.
                    // Return type determines whether we continue the signIn flow or save it in a cookie.
                    // We'll handle redirection manually below based on the 'returnTo' parameter.
                    return false; // Prevent FirebaseUI from automatically redirecting
                },
                uiShown: function() {
                    // The widget is rendered. Hide the loader.
                    loader.style.display = 'none';
                }
            },
            signInFlow: 'popup', // 'popup' for easier cross-domain, 'redirect' if all domains are same
            signInOptions: [
                // List of Firebase providers supported.
                firebase.auth.EmailAuthProvider.PROVIDER_ID,
                // You can add other providers here if enabled in Firebase Console:
                // firebase.auth.GoogleAuthProvider.PROVIDER_ID,
                // firebase.auth.GithubAuthProvider.PROVIDER_ID,
            ],
            // Optional: Terms of service url.
            // tosUrl: '<your-tos-url>',
            // Optional: Privacy policy url.
            // privacyPolicyUrl: '<your-privacy-policy-url>'
        };

        // Firebase Auth State Listener
        auth.onAuthStateChanged(function(user) {
            if (user) {
                // User is signed in.
                loader.style.display = 'none';
                authContainer.style.display = 'none'; // Hide the login form
                userInfoDiv.style.display = 'block'; // Show user info
                displayNameSpan.textContent = user.displayName || user.email; // Fallback to email if no display name
                userEmailSpan.textContent = user.email;

                // Check for 'returnTo' URL parameter
                const urlParams = new URLSearchParams(window.location.search);
                const returnToUrl = urlParams.get('returnTo');

                if (returnToUrl) {
                    backToSiteButton.style.display = 'inline-block';
                    backToSiteButton.onclick = function() {
                        window.location.href = decodeURIComponent(returnToUrl);
                    };
                } else {
                    backToSiteButton.style.display = 'none'; // Hide if no return URL
                }

                console.log("User logged in:", user.uid, user.email);

            } else {
                // User is signed out.
                userInfoDiv.style.display = 'none'; // Hide user info
                backToSiteButton.style.display = 'none'; // Hide button
                authContainer.style.display = 'block'; // Show the login form
                loader.style.display = 'block'; // Show loader while FirebaseUI loads
                ui.start('#firebaseui-auth-container', uiConfig); // Render the FirebaseUI Widget
                console.log("User is logged out.");
            }
        });

        // Logout Button Handler
        logoutButton.addEventListener('click', function() {
            auth.signOut().then(function() {
                // Sign-out successful. onAuthStateChanged will handle UI update.
                console.log('User signed out.');
            }).catch(function(error) {
                // An error happened.
                console.error('Sign Out Error:', error);
                alert('Error signing out: ' + error.message);
            });
        });

    </script>
</body>
</html>
